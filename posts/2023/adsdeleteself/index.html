<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>利用ADS删除自身</title>
    <meta name="description" content="自删除">
    <meta name="keywords" content='code, bypass, trick'>

    <meta property="og:url" content="https://github.com/2867a0/posts/2023/adsdeleteself/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="利用ADS删除自身">
    <meta property="og:description" content="自删除">
    <meta property="og:image" content="/images/home.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="利用ADS删除自身">
    <meta name="twitter:description" content="自删除">
    <meta property="twitter:domain" content="https://github.com/2867a0/posts/2023/adsdeleteself/">
    <meta property="twitter:url" content="https://github.com/2867a0/posts/2023/adsdeleteself/">
    <meta name="twitter:image" content="/images/home.jpg">

    
    <link rel="canonical" href="https://github.com/2867a0/posts/2023/adsdeleteself/" />

    <link rel="stylesheet" type="text/css" href="https://github.com/2867a0//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://github.com/2867a0//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://github.com/2867a0//css/dark.css">

    <script src="https://github.com/2867a0//js/svg-injector.min.js"></script>
    <script src="https://github.com/2867a0//js/feather-icons.min.js"></script>
    <script src="https://github.com/2867a0//js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://github.com/2867a0/">
                <img src="https://github.com/2867a0//images/home.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://github.com/2867a0/">2867a0</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://github.com/2867a0/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/2867a0/posts"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/2867a0/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/2867a0/about/"><span data-feather='code'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/2867a0"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://github.com/2867a0/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/2867a0/posts"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/2867a0/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/2867a0/about/"><span data-feather='code'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/2867a0"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>利用ADS删除自身</h1>
        <small role="doc-subtitle">自删除</small>
        <p class="post-date">
            June 11, 2023
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://github.com/2867a0/tags/code">code</a></li>
        
            <li class="post-tag"><a href="https://github.com/2867a0/tags/bypass">bypass</a></li>
        
            <li class="post-tag"><a href="https://github.com/2867a0/tags/trick">trick</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h2 id="ads">ADS</h2>
<p>Microsoft于90年代初期引入了一种称为“数据流”的概念，从而使NTFS可以作为Macintosh客户端访问文件服务器的文件系统。因为Mac OS 是利用Mac的分层式文件系统（HFS)上所谓的资源分支数据流，用于存放图标等应用程序的元数据。NTFS和FAT的差别就是FAT由一个数据流构成，而NTFS可以在一个文件内存里面存储多个数据流。</p>
<p>在windows协议MS-FSA中ADS的定义：一个被命名的数据流是一个文件或者目录的一部分，它们可以独立于默认数据流被单独的打开。许多数据流的操作之影响数据流并不影响其他数据流，文件和目录</p>
<p>所有的文件在NTFS中至少包含一个主数据流，也就是用户可见的文件或是目录，一个文件在NTFS中真正的文件名称格式：</p>
<pre tabindex="0"><code>&lt;文件名&gt;:&lt;流名&gt;:&lt;流种类&gt;
</code></pre><p>文件ADS默认没有流名字，一个文件<code>test.txt</code>在NTFS中的全名为<code>test.txt::$DATA</code></p>
<p>文件夹没有默认的数据流（也就是没有主数据流），但是有一个默认的目录流为<code>$INDEX_ALLOCATION</code>，默认的流名为<code>$I30</code>。比如文件夹<code>testDir</code>全名为<code>testDir:$I30:$INDEX_ALLOCATION</code></p>
<p>假设查看文件<code>1.txt</code>的数据流内容，可以输入如下命令，其内容和<code>1.txt</code>是一样的，在数据流中添加的内容保存后会被写入对应的文件中。如下图，原来<code>1.txt</code>中只有内容1.txt，在数据流中写入2，保存后重新打开原文件，发现2被写入</p>
<pre tabindex="0"><code>notepad.exe 1.txt::$DATA
</code></pre><p><img src="/images/2023/adsdeleteself/image-20230610204240146.png" alt="image-20230610204240146.png"></p>
<p>简单提一下，用微软的streams.exe工具可以遍历出程序的备用数据流</p>
<h2 id="自删除">自删除</h2>
<p>自删除原理是，将文件重命名为数据流格式，然后删除该数据流。利用这种方法去删除可以无视当前文件句柄占用，如果程序处于运行中也不会破坏程序的运行。</p>
<p>代码如下，首先以<code>DELETE</code>方式获取自身文件句柄，调用<code>SetFileInformationByHandle()</code>将文件名修改为<code>:anyany</code>，以调试编译运行的时候<code>SetFileInformationByHandle()</code>函数会报错，忽略就行。</p>
<p><img src="/images/2023/adsdeleteself/image-20230611073536926.png" alt="image-20230611073536926.png"></p>
<p>修改完成后重新打开一次文件句柄，再次调用<code>SetFileInformationByHandle()</code>删除文件</p>
<p><img src="/images/2023/adsdeleteself/6677dc2ec879bb349924f65dd52b4c11.png" alt="6677dc2ec879bb349924f65dd52b4c11.png"></p>
<p>程序执行，自删除文件，后续的代码依旧可以运行</p>
<p><img src="/images/2023/adsdeleteself/image-20230611074025955.png" alt="image-20230611074025955.png"></p>
<p>上面的代码中我设置了两个暂停，第一个pause中，如果以代码调试的方式打开程序，<code>CreateFileW</code>函数会获取不到文件句柄，解决方法也简单，x64gbd附加到进程就可以调试了。</p>
<p>第二个pause是在将文件修改为数据流之后，用winhex创建磁盘快照可以发现，原来的程序变成了0B，进入程序之后<code>any</code>文件其实就是原来的程序</p>
<p><img src="/images/2023/adsdeleteself/image-20230610205747913.png" alt="image-20230610205747913.png"></p>
<p><img src="/images/2023/adsdeleteself/image-20230610205636515.png" alt="image-20230610205636515.png"></p>
<p>从上面可以看出，我们在第一次rename的时候是将程序移动到了数据流中（磁盘中会有一个0B的文件），第二次删除的时候删除的0B文件是我们的数据流文件。</p>
<p>这里还有一个点，在第一次rename文件之后如果不关闭程序的句柄（也就是一直暂停到第二个pause），火绒剑操作这个文件的时候会卡死</p>
<p><img src="/images/2023/adsdeleteself/image-20230610210315963.png" alt="image-20230610210315963.png"></p>
<h2 id="完整代码">完整代码</h2>
<p>CloseSelf.h</p>
<pre tabindex="0"><code>#pragma once

#pragma comment(lib, &#34;Shlwapi.lib&#34;)

#include &lt;Windows.h&gt;
#include &lt;shlwapi.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

#define DS_STREAM_RENAME L&#34;:anyany:$DATA&#34;
#define DS_DEBUG_LOG(msg) wprintf(L&#34;[LOG] - %s\n&#34;, msg)

BOOL ds_deposite_handle(HANDLE hHandle);
BOOL ds_rename_handle(HANDLE hHandle);
HANDLE ds_open_handle(PWCHAR pwPath);
</code></pre><p>CloseSelf.cpp</p>
<pre tabindex="0"><code>#include &#34;CloseSelf.h&#34;


HANDLE ds_open_handle(PWCHAR pwPath) {
    return CreateFileW(pwPath, DELETE, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
}

BOOL ds_rename_handle(HANDLE hHandle) {
    FILE_RENAME_INFO fRename;
    RtlSecureZeroMemory(&amp;fRename, sizeof(fRename));

    // set our FileNameLength and FileName to DS_STREAM_RENAME
    LPWSTR lpwStream = (LPWSTR)DS_STREAM_RENAME;
    fRename.FileNameLength = sizeof(lpwStream);
    RtlCopyMemory(fRename.FileName, lpwStream, sizeof(lpwStream));

    return SetFileInformationByHandle(hHandle, FileRenameInfo, &amp;fRename, sizeof(fRename) + sizeof(lpwStream));
}

BOOL ds_deposite_handle(HANDLE hHandle) {
    // set FILE_DISPOSITION_INFO::DeleteFile to TRUE
    FILE_DISPOSITION_INFO fDelete;
    RtlSecureZeroMemory(&amp;fDelete, sizeof(fDelete));

    fDelete.DeleteFile = TRUE;

    return SetFileInformationByHandle(hHandle, FileDispositionInfo, &amp;fDelete, sizeof(fDelete));
}
</code></pre><p>SelfDelete.cpp</p>
<pre tabindex="0"><code>// SelfDelete.cpp : 此文件包含 &#34;main&#34; 函数。程序执行将在此处开始并结束。
//

#include &lt;iostream&gt;
#include &lt;Windows.h&gt;
#include &lt;time.h&gt;
#include &#34;CloseSelf.h&#34;

BOOL CloseSelf() {
    WCHAR wcPath[MAX_PATH + 1];
    RtlSecureZeroMemory(wcPath, sizeof(wcPath));

    // 获取当前文件名
    if (GetModuleFileNameW(NULL, wcPath, MAX_PATH) == 0)
    {
        DS_DEBUG_LOG(L&#34;failed to get the current module handle&#34;);
        return FALSE;
    }

    // 获取当前文件句柄
    HANDLE hCurrent = ds_open_handle(wcPath);
    if (hCurrent == INVALID_HANDLE_VALUE)
    {
        DS_DEBUG_LOG(L&#34;failed to acquire handle to current running process&#34;);
        std::cout &lt;&lt; &#34;Error code: &#34; &lt;&lt; GetLastError() &lt;&lt; std::endl;
        return FALSE;
    }

    // rename the associated HANDLE&#39;s file name
    system(&#34;pause&#34;);
    DS_DEBUG_LOG(L&#34;attempting to rename file name&#34;);
    if (!ds_rename_handle(hCurrent))
    {
        DS_DEBUG_LOG(L&#34;failed to rename to stream&#34;);
        return FALSE;
    }

    DS_DEBUG_LOG(L&#34;successfully renamed file primary :$DATA ADS to specified stream, closing initial handle&#34;);

    system(&#34;pause&#34;);
    // 不关闭句柄可造成其他程序读取该文件是假死现象
    CloseHandle(hCurrent);

    // open another handle, trigger deletion on close
    hCurrent = ds_open_handle(wcPath);
    if (hCurrent == INVALID_HANDLE_VALUE)
    {
        DS_DEBUG_LOG(L&#34;failed to reopen current module&#34;);
        return FALSE;
    }

    if (!ds_deposite_handle(hCurrent))
    {
        DS_DEBUG_LOG(L&#34;failed to set delete deposition&#34;);
        return FALSE;
    }

    // trigger the deletion deposition on hCurrent
    DS_DEBUG_LOG(L&#34;closing handle to trigger deletion deposition&#34;);
    CloseHandle(hCurrent);

    // verify we&#39;ve been deleted
    if (PathFileExistsW(wcPath))
    {
        DS_DEBUG_LOG(L&#34;failed to delete copy, file still exists&#34;);
        return FALSE;
    }

    DS_DEBUG_LOG(L&#34;successfully deleted self from disk&#34;);
    return TRUE;
}

void do_something() {
    int i = 0;
    while (true) {
        std::cout &lt;&lt; &#34;test: &#34; &lt;&lt; i &lt;&lt; std::endl;
        i++;
        Sleep(1000);
    }
}

int wmain(int argc, wchar_t* argv[], wchar_t* envp[]) {
    HANDLE exeHandle = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)do_something, NULL, NULL, NULL);

    Sleep(3000);
    CloseSelf();

    WaitForSingleObject(exeHandle, INFINITE);
}
</code></pre>
        </p>
    </div>

    <div class="prev-next">
        
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#ads">ADS</a></li>
        <li><a href="#自删除">自删除</a></li>
        <li><a href="#完整代码">完整代码</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2024 The Marauders</span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
